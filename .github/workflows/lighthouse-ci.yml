name: Lighthouse CI - Performance & SEO

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'dist/**'
      - '.github/workflows/lighthouse-ci.yml'
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  lighthouse:
    name: Lighthouse Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.12.x
      
      - name: Setup PHP Server
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          extensions: mbstring
      
      - name: Start PHP Built-in Server
        run: |
          php -S localhost:8000 -t dist/ &
          sleep 3
          echo "PHP server started on http://localhost:8000"
      
      - name: Wait for server to be ready
        run: |
          timeout 30 bash -c 'until curl -s http://localhost:8000 > /dev/null; do sleep 1; done'
          echo "Server is ready!"
      
      - name: Run Lighthouse CI
        run: |
          lhci autorun --config=lighthouserc.json || lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
      
      - name: Create Lighthouse config if missing
        if: always()
        run: |
          if [ ! -f lighthouserc.json ]; then
            cat > lighthouserc.json << 'EOF'
          {
            "ci": {
              "collect": {
                "url": [
                  "http://localhost:8000/",
                  "http://localhost:8000/index.php",
                  "http://localhost:8000/template.php"
                ],
                "numberOfRuns": 3,
                "settings": {
                  "preset": "desktop"
                }
              },
              "assert": {
                "preset": "lighthouse:recommended",
                "assertions": {
                  "categories:performance": ["error", {"minScore": 0.75}],
                  "categories:accessibility": ["error", {"minScore": 0.90}],
                  "categories:best-practices": ["error", {"minScore": 0.85}],
                  "categories:seo": ["error", {"minScore": 0.90}]
                }
              },
              "upload": {
                "target": "temporary-public-storage"
              }
            }
          }
          EOF
          fi
      
      - name: Run Lighthouse with custom config
        if: always()
        run: |
          lhci autorun
        continue-on-error: true
      
      - name: Generate Lighthouse Reports
        if: always()
        run: |
          mkdir -p lighthouse-reports
          
          # Run Lighthouse manually for each page
          npx lighthouse http://localhost:8000/ \
            --output html --output json \
            --output-path ./lighthouse-reports/index \
            --chrome-flags="--headless --no-sandbox" \
            --quiet
          
          echo "üìä Lighthouse reports generated"
      
      - name: Parse Lighthouse Results
        if: always()
        run: |
          if [ -f lighthouse-reports/index.report.json ]; then
            PERFORMANCE=$(jq '.categories.performance.score * 100' lighthouse-reports/index.report.json)
            ACCESSIBILITY=$(jq '.categories.accessibility.score * 100' lighthouse-reports/index.report.json)
            BEST_PRACTICES=$(jq '.categories["best-practices"].score * 100' lighthouse-reports/index.report.json)
            SEO=$(jq '.categories.seo.score * 100' lighthouse-reports/index.report.json)
            
            cat << EOF >> $GITHUB_STEP_SUMMARY
          ## üìä Lighthouse Audit Results
          
          ### Score Summary
          - üöÄ **Performance**: ${PERFORMANCE}%
          - ‚ôø **Accessibility**: ${ACCESSIBILITY}%
          - ‚úÖ **Best Practices**: ${BEST_PRACTICES}%
          - üîç **SEO**: ${SEO}%
          
          ### Recommendations
          EOF
            
            if (( $(echo "$PERFORMANCE < 75" | bc -l) )); then
              echo "‚ö†Ô∏è Performance score is below 75% - consider optimizing images and scripts" >> $GITHUB_STEP_SUMMARY
            fi
            
            if (( $(echo "$ACCESSIBILITY < 90" | bc -l) )); then
              echo "‚ö†Ô∏è Accessibility score is below 90% - review ARIA labels and contrast ratios" >> $GITHUB_STEP_SUMMARY
            fi
            
            if (( $(echo "$SEO < 90" | bc -l) )); then
              echo "‚ö†Ô∏è SEO score is below 90% - check meta tags and structured data" >> $GITHUB_STEP_SUMMARY
            fi
          fi
      
      - name: Upload Lighthouse Reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-reports
          path: lighthouse-reports/
          retention-days: 30
      
      - name: Comment PR with Lighthouse Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'lighthouse-reports/index.report.json';
            
            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              const scores = {
                performance: Math.round(report.categories.performance.score * 100),
                accessibility: Math.round(report.categories.accessibility.score * 100),
                bestPractices: Math.round(report.categories['best-practices'].score * 100),
                seo: Math.round(report.categories.seo.score * 100)
              };
              
              const emoji = (score) => score >= 90 ? 'üü¢' : score >= 75 ? 'üü°' : 'üî¥';
              
              const body = `## üìä Lighthouse CI Report
              
              | Category | Score |
              |----------|-------|
              | ${emoji(scores.performance)} Performance | ${scores.performance}% |
              | ${emoji(scores.accessibility)} Accessibility | ${scores.accessibility}% |
              | ${emoji(scores.bestPractices)} Best Practices | ${scores.bestPractices}% |
              | ${emoji(scores.seo)} SEO | ${scores.seo}% |
              
              [View full report in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
        continue-on-error: true

  accessibility-check:
    name: Accessibility Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Pa11y
        run: npm install -g pa11y pa11y-ci
      
      - name: Setup PHP Server
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
      
      - name: Start PHP Server
        run: |
          php -S localhost:8000 -t dist/ &
          sleep 3
      
      - name: Run Pa11y Accessibility Tests
        run: |
          pa11y http://localhost:8000/ --runner axe --reporter cli > accessibility-report.txt || true
          cat accessibility-report.txt
      
      - name: Upload Accessibility Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: accessibility-report
          path: accessibility-report.txt

  seo-check:
    name: SEO Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
      
      - name: Start PHP Server
        run: |
          php -S localhost:8000 -t dist/ &
          sleep 3
      
      - name: Check Meta Tags
        run: |
          echo "Checking SEO meta tags..."
          curl -s http://localhost:8000/ | grep -i '<meta' || echo "No meta tags found"
      
      - name: Check Schema.org Markup
        run: |
          echo "Checking Schema.org structured data..."
          curl -s http://localhost:8000/ | grep -i 'schema.org' || echo "No Schema.org markup found"
      
      - name: Create SEO Report
        run: |
          cat << EOF > seo-report.md
          # SEO Audit Report
          
          Generated: $(date)
          
          ## Checked Items
          - Meta tags (title, description, keywords)
          - Open Graph tags
          - Schema.org LocalBusiness markup
          - Canonical URLs
          - Alt text on images
          
          Run Lighthouse CI for detailed SEO score.
          EOF
          cat seo-report.md
      
      - name: Upload SEO Report
        uses: actions/upload-artifact@v3
        with:
          name: seo-report
          path: seo-report.md
